<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Three.js ì…ë¬¸</title>
  <style>
    body { margin: 0; }
    canvas { display: block; }
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>

  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.141.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.141.0/examples/jsm/"
      }
    }
  </script>

  <script type="module">
    const ws = new WebSocket("ws://192.168.0.xx:3001"); // ë§¥ IPë¡œ ë„£ê¸°
    ws.onopen = () => {
      console.log("ğŸ”— WebSocket Connected to server");
    };

    ws.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        if (data.type === "command") {
          console.log("ì„œë²„ì—ì„œ ëª…ë ¹ ìˆ˜ì‹ :", data.command);
          parseCommand(data.command);    // ì½˜ì†” ëª…ë ¹ì–´ íŒŒì„œ í•¨ìˆ˜ í˜¸ì¶œ
        }
      } catch (e) {
        console.error("ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜", e);
      }
    };
    // --- ëª¨ë“ˆ ì„í¬íŠ¸ ---
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    // --- ì „ì—­ ë³€ìˆ˜ ---
    let model_car;
    const clock = new THREE.Clock();

    // í‚¤ë³´ë“œ ìƒíƒœ
    const keys = {
      ArrowUp: false,
      ArrowDown: false,
      ArrowLeft: false,
      ArrowRight: false,
    };
    
    // ë§ˆìš°ìŠ¤ íœ  ì¤Œ ì„¤ì •
    const minZoomDistance = 2.0;
    const maxZoomDistance = 15.0;
    const zoomSpeed = 0.005;
    
    // --- ë°© ì¢Œí‘œ ë° ìë™ ì´ë™ ë³€ìˆ˜ ---

    const car_y = 0.2;
    const roomData = {
      living_room: new THREE.Vector3(0.0, car_y, -0.3),
      inner_room: new THREE.Vector3(0.25, car_y, 1.2),
      kitchen: new THREE.Vector3(-0.9, car_y, 0.0)
    };

    // ì¤‘ê°„ ê²½ë¡œì  (Waypoint) ì •ì˜
    const INNER_ROOM_DOORWAY = new THREE.Vector3(
      0.2,
      car_y,
      0.4
    );
    const KITCHEN_DOORWAY = new THREE.Vector3(
      -0.75,
      car_y,
      -0.15
    );

    // ì´ë™ ê²½ë¡œ(Path) ë°ì´í„°
    const pathData = {
      living_room_to_inner_room: [ INNER_ROOM_DOORWAY, roomData.inner_room ],
      inner_room_to_living_room: [ INNER_ROOM_DOORWAY, roomData.living_room ],
      living_room_to_kitchen: [ KITCHEN_DOORWAY, roomData.kitchen ],
      kitchen_to_living_room: [ KITCHEN_DOORWAY, roomData.living_room ],
      inner_room_to_kitchen: [ INNER_ROOM_DOORWAY, roomData.living_room, KITCHEN_DOORWAY, roomData.kitchen ],
      kitchen_to_inner_room: [ KITCHEN_DOORWAY, roomData.living_room, INNER_ROOM_DOORWAY, roomData.inner_room ]
    };

    // ìë™ ì´ë™ ìƒíƒœ ë³€ìˆ˜
    let currentRoom = "living_room"; // ìë™ì°¨ì˜ í˜„ì¬ ë°© (ì‹œì‘ ìœ„ì¹˜)
    let movementQueue = []; // ë”°ë¼ê°ˆ ê²½ë¡œì  ë°°ì—´
    let currentTarget = null; // í˜„ì¬ ì´ë™ ì¤‘ì¸ ëª©í‘œ ê²½ë¡œì 
    
    // --- 3. Scene ìƒì„± ---
    let scene = new THREE.Scene();
    scene.background = new THREE.Color("skyblue");

    // --- 4. Camera ìƒì„± ---
    let camera = new THREE.PerspectiveCamera(
      45, // fov
      window.innerWidth / window.innerHeight, // aspect
      0.1, // near
      1000 // far
    );
    camera.position.set(0, 5, 2); // Yì¶•ì„ ë†’ì—¬ ìœ„ì—ì„œ ë³´ë„ë¡ ì„¤ì •

    // --- 5. Light ì¶”ê°€ ---
    let PLight = new THREE.PointLight(0xffffff, 1.0);
    let ALight = new THREE.AmbientLight(0xffffff, 0.5);
    PLight.position.set(10, 10, 10);
    scene.add(PLight, ALight);

    // --- 6. Renderer ìƒì„± ---
    let renderer = new THREE.WebGLRenderer({
      canvas: document.querySelector("#canvas"),
      antialias: true,
    });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.outputEncoding = THREE.sRGBEncoding;

    // --- 7. 3D ëª¨ë¸ ë¶ˆëŸ¬ì˜¤ê¸° ---
    let loader = new GLTFLoader();
    
    const modelPath_House = "models/house_ex4.glb";
    const modelPath_Car = "models/car_pika.glb"; // (ê²½ë¡œ ë’¤ ê³µë°± ì œê±°ë¨)

    loader.load(modelPath_House, function (gltf) {
      const model = gltf.scene;
      model.scale.set(2, 2, 2);
      scene.add(model);
    });
    
    loader.load(modelPath_Car, function (gltf) {
      model_car = gltf.scene;
      model_car.scale.set(0.1, 0.1, 0.1);
      model_car.position.set(0.0,car_y,-0.3);
      scene.add(model_car);
    });

    // --- 8. ìë™ ì´ë™ í•¨ìˆ˜ ---
    /**
     * ì§€ì •ëœ ë°©ìœ¼ë¡œ ìë™ ì´ë™ì„ ì‹œì‘í•©ë‹ˆë‹¤.
     */
    function moveToRoom(toRoomName) {
      if (toRoomName === currentRoom || currentTarget) {
        return; // ì´ë¯¸ ì´ë™ ì¤‘ì´ê±°ë‚˜ ê°™ì€ ë°©ì´ë©´ ë¬´ì‹œ
      }
      
      const pathKey = `${currentRoom}_to_${toRoomName}`;
      const path = pathData[pathKey];

      if (!path) {
        console.error(`Error: '${pathKey}' ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
        return;
      }
      
      console.log(`ìë™ ì´ë™: ${pathKey}`);
      movementQueue = [...path]; // ê²½ë¡œ ë³µì‚¬

      if (movementQueue.length > 0) {
        // ìˆ˜ë™ ì¡°ì‘ í›„ ìœ„ì¹˜ ë³´ì •ì„ ìœ„í•´ ì‹œì‘ì (í˜„ì¬ ë°©)ìœ¼ë¡œ ì°¨ë¥¼ ìŠ¤ëƒ…
        model_car.position.copy(roomData[currentRoom]);
        currentTarget = movementQueue.shift(); // ì²« ë²ˆì§¸ ê²½ë¡œì  ì„¤ì •
      }
      
      currentRoom = toRoomName; // í˜„ì¬ ë°© ìƒíƒœ ê°±ì‹ 
    }
    // --- [ìƒˆ ê¸°ëŠ¥] ì½˜ì†” ëª…ë ¹ì–´ íŒŒì„œ í•¨ìˆ˜ ---
    /**
     * (F12 ì½˜ì†” í…ŒìŠ¤íŠ¸ìš©)
     * ì™¸ë¶€ ê¸°ê¸°ì—ì„œ ë°›ì€ ê²ƒê³¼ ìœ ì‚¬í•œ í…ìŠ¤íŠ¸ ëª…ë ¹ì„ íŒŒì‹±í•©ë‹ˆë‹¤.
     * @param {string} message - ì˜ˆ: "<maum_1>(direction=1)<maum_end>"
     */
    // --- [ìˆ˜ì •] ì •ê·œì‹ì„ ì§€ì›í•˜ë„ë¡ if/else ifë¡œ ë³€ê²½ëœ íŒŒì„œ í•¨ìˆ˜ ---
    /**
     * ì™¸ë¶€ ê¸°ê¸°ì—ì„œ ë°›ì€ í…ìŠ¤íŠ¸ ëª…ë ¹ì„ íŒŒì‹±í•©ë‹ˆë‹¤.
     * @param {string} message - ì˜ˆ: "<maum_1>..." ë˜ëŠ” "<maum_2>..."
     */
    function parseCommand(message) {
      console.log(`ìˆ˜ì‹ ëœ ì›ë³¸ ë©”ì‹œì§€: ${message}`);

      // --- [ìƒˆ ê¸°ëŠ¥] <maum_2> ì•ŒëŒ ëª…ë ¹ì„ ì²˜ë¦¬í•  ì •ê·œì‹ ---
      // íŒ¨í„´: <maum_2>(mode=2, time="(.+)")<maum_end>
      // (.+) : ê´„í˜¸ ì•ˆì˜ ".+"ê°€ "ë”°ì˜´í‘œ ì•ˆì˜ ëª¨ë“  ë¬¸ìì—´"ì„ ìº¡ì²˜í•©ë‹ˆë‹¤.
      const alarmRegex = /<maum_2>\(mode=2, time="(.+)"\)<maum_end>/;
      const alarmMatch = message.match(alarmRegex); // ë©”ì‹œì§€ì™€ ì •ê·œì‹ íŒ¨í„´ ë¹„êµ

      // 1. [ìƒˆ ê¸°ëŠ¥] <maum_2> ì•ŒëŒ ëª…ë ¹ì´ ë§¤ì¹˜ë˜ì—ˆëŠ”ì§€ í™•ì¸
      if (alarmMatch) {
        // alarmMatch[0]ì€ ë§¤ì¹˜ëœ ì „ì²´ ë¬¸ìì—´ì…ë‹ˆë‹¤.
        // alarmMatch[1]ì€ ì²« ë²ˆì§¸ ìº¡ì²˜ ê·¸ë£¹ '(.+)'ì— í•´ë‹¹í•˜ëŠ” ê°’ì…ë‹ˆë‹¤. (ì˜ˆ: "ì„¸ì‹œ")
        const timeString = alarmMatch[1]; 
        
        console.log(`ëª…ë ¹ íŒŒì‹±: ì•ŒëŒ ì„¤ì •, ì¶”ì¶œëœ ì‹œê°„ = ${timeString}`);
        
        // (ë‚˜ì¤‘ì— ì´ ë¶€ë¶„ì—ì„œ ì‹¤ì œ ì•ŒëŒ ì„¤ì • í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤)
        // setAlarm(timeString); 
      }

      // 2. [ê¸°ì¡´ ê¸°ëŠ¥] <maum_1> ì´ë™ ëª…ë ¹ (else ifë¡œ ë³€ê²½)
      else if (message === "<maum_1>(direction=1)<maum_end>") {
        console.log("ëª…ë ¹ íŒŒì‹±: 'living_room'ìœ¼ë¡œ ì´ë™");
        moveToRoom("living_room");
      }
      else if (message === "<maum_1>(direction=2)<maum_end>") {
        console.log("ëª…ë ¹ íŒŒì‹±: 'inner_room'ìœ¼ë¡œ ì´ë™");
        moveToRoom("inner_room");
      }
      else if (message === "<maum_1>(direction=3)<maum_end>") {
        console.log("ëª…ë ¹ íŒŒì‹±: 'kitchen'ìœ¼ë¡œ ì´ë™");
        moveToRoom("kitchen");
      }

      // 3. ì–´ë–¤ íŒ¨í„´ê³¼ë„ ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” ê²½ìš°
      else {
        console.error(`ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹ì…ë‹ˆë‹¤: ${message}`);
      }
    }

    // ì½˜ì†”ì—ì„œ 'parseCommand' í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆë„ë¡ ì „ì—­ì— ë…¸ì¶œ
    window.parseCommand = parseCommand;
    // ì½˜ì†” í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ì „ì—­(window)ì— ë…¸ì¶œ
    //window.moveToRoom = moveToRoom;


    // --- 9. ì• ë‹ˆë©”ì´ì…˜ ë£¨í”„ ---
    function animate() {
      requestAnimationFrame(animate);

      const delta = clock.getDelta();

      // ë§ˆìš°ìŠ¤ íœ  ì¤Œì„ ìœ„í•´ ì¹´ë©”ë¼ëŠ” í•­ìƒ ì›ì ì„ ë°”ë¼ë´„
      camera.lookAt(0, 0, 0);

      if (model_car) {
        // A. ìë™ ì´ë™ ëª¨ë“œ (currentTargetì´ ì„¤ì •ëœ ê²½ìš°)
        if (currentTarget) {
          model_car.position.lerp(currentTarget, 0.05); // ëª©í‘œë¡œ 5%ì”© ì´ë™
          model_car.lookAt(currentTarget); // ëª©í‘œ ì§€ì  ë°”ë¼ë³´ê¸°

          // ëª©í‘œì— 0.01 ì´ë‚´ë¡œ ê·¼ì ‘í•˜ë©´
          if (model_car.position.distanceTo(currentTarget) < 0.01) {
            model_car.position.copy(currentTarget); // ì •í™•í•œ ìœ„ì¹˜ë¡œ ìŠ¤ëƒ…

            if (movementQueue.length > 0) {
              currentTarget = movementQueue.shift(); // ë‹¤ìŒ ê²½ë¡œì  ì„¤ì •
            } else {
              currentTarget = null; // ì´ë™ ì™„ë£Œ (ìˆ˜ë™ ëª¨ë“œ ì „í™˜)
            }
          }
        } 
        // B. ìˆ˜ë™ ì¡°ì‘ ëª¨ë“œ (currentTargetì´ nullì¸ ê²½ìš°)
        else {
          const moveSpeed = 0.1 * delta;
          const rotateSpeed = 5 * delta;

          if (keys.ArrowUp) {
            model_car.translateZ((moveSpeed / model_car.scale.x));
          }
          if (keys.ArrowDown) {
            model_car.translateZ(-(moveSpeed / model_car.scale.x));
          }
          if (keys.ArrowLeft) {
            model_car.rotation.y += rotateSpeed;
          }
          if (keys.ArrowRight) {
            model_car.rotation.y -= rotateSpeed;
          }
        }
      }

      renderer.render(scene, camera); // ì”¬ ë Œë”ë§
    }
    // ì• ë‹ˆë©”ì´ì…˜ ë£¨í”„ 1íšŒë§Œ í˜¸ì¶œ
    animate();


    // --- 10. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---

    // ë¸Œë¼ìš°ì € ì°½ í¬ê¸° ë³€ê²½
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // í‚¤ë³´ë“œ ëˆ„ë¦„
    window.addEventListener('keydown', (e) => {
      if (e.key in keys) {
        keys[e.key] = true;
      }
    });

    // í‚¤ë³´ë“œ ë—Œ
    window.addEventListener('keyup', (e) => {
      if (e.key in keys) {
        keys[e.key] = false;
      }
    });

    // ë§ˆìš°ìŠ¤ íœ  ì¤Œ
    window.addEventListener('wheel', (e) => {
      const direction = camera.position.clone().normalize();
      let distance = camera.position.length();
      
      distance += e.deltaY * zoomSpeed; // ìŠ¤í¬ë¡¤ ë°©í–¥ì— ë”°ë¼ ê±°ë¦¬ ì¡°ì ˆ
      distance = Math.max(minZoomDistance, Math.min(maxZoomDistance, distance)); // ê±°ë¦¬ ì œí•œ
      
      camera.position.copy(direction).multiplyScalar(distance); // ìƒˆ ìœ„ì¹˜ ì ìš©
    });
    
    // 1ì´ˆë§ˆë‹¤ ìë™ì°¨ ì¢Œí‘œ ì½˜ì†”ì— ì¶œë ¥
    setInterval(() => {
      if (model_car) {
        const x = model_car.position.x.toFixed(2);
        const y = model_car.position.y.toFixed(2);
        const z = model_car.position.z.toFixed(2);
        console.log(`ğŸš— Car Position: (x: ${x}, y: ${y}, z: ${z})`);
      }
    }, 1000); // 1ì´ˆ

  </script>
</body>
</html>